import type { Provider } from "@src/types.ts";
import { OllamaProvider } from "@src/providers/ollama.ts";
import { CloudProvider } from "@src/providers/cloud.ts";
import {
  ClaudeCLIProvider,
  GeminiCLIProvider,
  KiloCLIProvider,
  detectCLIs,
  getCliPath,
} from "@src/providers/cli-providers.ts";

/**
 * Factory function to get the appropriate provider based on model name.
 *
 * Routing logic:
 * - Models containing "/" (e.g., "anthropic/claude-3-opus") -> CloudProvider
 * - Models starting with "gpt-" (e.g., "gpt-4") -> CloudProvider
 * - All other models -> OllamaProvider (local)
 */
export function getProvider(model: string): Provider {
  const isCloudModel = model.includes("/") || model.startsWith("gpt-");
  const { claude, gemini, kilo } = detectCLIs();

  if (claude && (model.includes("claude") || model.includes("anthropic") || model === "claude")) {
    return new ClaudeCLIProvider(model);
  }
  
  if (gemini && (model.includes("gemini") || model === "gemini")) {
    return new GeminiCLIProvider(model);
  }
  
  if (kilo && (model.includes("kilo") || model === "kilo")) {
    return new KiloCLIProvider(model);
  }

  if (isCloudModel) {
    return new CloudProvider();
  }

  return new OllamaProvider();
}
  
  if (gemini && (model.includes("gemini") || model === "gemini")) {
    return new GeminiCLIProvider(model);
  }
  
  if (kilo && (model.includes("kilo") || model === "kilo" || model.startsWith("claude"))) {
    return new KiloCLIProvider(model);
  }
  
  if (gemini && (model.includes("gemini") || model === "gemini")) {
    return new GeminiCLIProvider(model);
  }
  
  if (kilo && (model.includes("kilo") || model === "kilo" || model.startsWith("claude-"))) {
    return new KiloCLIProvider(model);
  }

  if (isCloudModel) {
    return new CloudProvider();
  }

  return new OllamaProvider();
}

/**
 * Check if a model requires cloud provider
 */
export function isCloudModel(model: string): boolean {
  return model.includes("/") || model.startsWith("gpt-");
}
